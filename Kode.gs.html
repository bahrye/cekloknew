const SPREADSHEET_ID = "1EIQY1DeGcwhEaYojbGMah-S5HbtsrON5YRy37bl_vLg"; 

const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
const usersSheet = ss.getSheetByName("Users");
const settingsSheet = ss.getSheetByName("Settings");
const holidaysSheet = ss.getSheetByName("Holidays");
const announcementsSheet = ss.getSheetByName("Announcements");
const teacherHolidaysSheet = ss.getSheetByName("TeacherHolidays");

function getUrutanNamaSheet_() {
  let sheet = ss.getSheetByName("UrutanNama");
  if (!sheet) {
    sheet = ss.insertSheet("UrutanNama");
    sheet.appendRow(["Nama", "Sekolah"]); // Kolom baru: Nama dan Sekolah
    SpreadsheetApp.flush(); 
  } else {
    // Jika sheet sudah ada, pastikan header kolom kedua adalah "Sekolah"
    const headers = sheet.getRange(1, 1, 1, 2).getValues()[0];
    if (headers[1] === "Urutan") {
      sheet.getRange(1, 2).setValue("Sekolah");
    }
  }
  return sheet;
}

function getAttendanceSheet_(year, month) {
  const monthStr = String(month).padStart(2, '0');
  const yearStr = String(year).slice(-2);
  const sheetName = `Attendance_${monthStr}_${yearStr}`;
  
  let sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    const headers = [
      "Timestamp", "Email", "Nama", "Sekolah", "Tanggal", 
      "JamMasuk", "JamPulang", "Keterangan"
    ];
    sheet.appendRow(headers);
    sheet.setFrozenRows(1);
    sheet.getRange("E:E").setNumberFormat("yyyy-mm-dd");
    sheet.getRange("F:G").setNumberFormat("@");
  }
  
  return sheet;
}

function doGet() {
  return HtmlService.createTemplateFromFile('index').evaluate()
      .setTitle("Aplikasi Ceklok Guru, Staff & Admin")
      .setFaviconUrl("https://i.imgur.com/CmVVVxB.png")
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function checkIfAdmin(email) {
  if (!email) return false;
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0].toLowerCase() === email.toLowerCase()) {
      return users[i][4] === 'admin';
    }
  }
  return false;
}

function checkIfAdminOrStaff(email) {
  if (!email) return false;
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0].toLowerCase() === email.toLowerCase()) {
      return users[i][4] === 'admin' || users[i][4] === 'staff';
    }
  }
  return false;
}

function userLogin(email, password) {
  try {
    const users = usersSheet.getDataRange().getValues();
    for (let i = 1; i < users.length; i++) {
      if (users[i][0].toLowerCase() === email.toLowerCase() && users[i][1] == password && users[i][4]) { 
        const schoolString = users[i][3] || "";
        const schools = schoolString.split(',').map(s => s.trim()).filter(Boolean);
        
        return { 
          status: "success", 
          user: { 
            email: users[i][0],
            name: users[i][2], 
            schools: schools,
            role: users[i][4]
          }
        };
      }
    }
    return { status: "failed", message: "Email, password salah, atau Anda tidak memiliki peran." };
  } catch(e) {
    return { status: "error", message: e.message };
  }
}

function getAppSettingsForUser(email, school, year, month) {
  const attendanceData = getMonthlyAttendance(email, school, year, month);
  let lockedMonths = [];
  try {
    const settingsData = settingsSheet.getDataRange().getValues();
    settingsData.forEach(row => {
      if (row[0] === 'locked_months' && row[1]) {
        lockedMonths = JSON.parse(row[1]);
      }
    });
  } catch (e) {}
  
  const today = new Date();
  if (today.getDate() > 10) {
    const lastMonthDate = new Date();
    lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
    const lastMonthStr = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
    if (!lockedMonths.includes(lastMonthStr)) lockedMonths.push(lastMonthStr);
  }

  const holidays = {};
  try {
    const holidaysData = holidaysSheet.getDataRange().getValues().slice(1);
    holidaysData.forEach(row => {
      if (row[0] instanceof Date && row[1]) holidays[Utilities.formatDate(row[0], "GMT", "yyyy-MM-dd")] = row[1];
    });
  } catch (e) {}

  const announcements = getAnnouncements();
  const teacherHolidays = getTeacherHolidays(email);

  return { 
    attendance: attendanceData, lockedMonths, holidays, announcements, teacherHolidays 
  };
}

function getMonthlyAttendance(email, school, year, month) {
  const attendanceData = {};
  const TIMEZONE = "GMT+8"; 
  try {
    const sheet = getAttendanceSheet_(year, month);
    if (sheet.getLastRow() < 2) return {}; 
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 8).getValues();

    data.forEach(row => {
      const recordEmail = row[1];
      const recordSchool = row[3];

      if (recordEmail === email && recordSchool === school) {
        const recordDate = new Date(row[4]);
        const formattedDate = Utilities.formatDate(recordDate, TIMEZONE, "yyyy-MM-dd");

        let checkIn = row[5] instanceof Date ? Utilities.formatDate(row[5], TIMEZONE, "HH:mm") : (row[5] || "").toString().replace(/^'/, "");
        let checkOut = row[6] instanceof Date ? Utilities.formatDate(row[6], TIMEZONE, "HH:mm") : (row[6] || "").toString().replace(/^'/, "");

        attendanceData[formattedDate] = { checkIn, checkOut, reason: row[7] || "" };
      }
    });
    return attendanceData;
  } catch (e) {
    Logger.log(`Error di getMonthlyAttendance: ${e.toString()}`);
    return {}; 
  }
}

function saveMonthlyAttendance(payload) {
  const { email, name, school, attendance } = payload;
  if (!school) return { status: "error", message: "Informasi sekolah tidak valid." };

  const firstDateKey = Object.keys(attendance)[0];
  if (!firstDateKey) return { status: "success", message: "Tidak ada data untuk disimpan." };
  
  const d = new Date(firstDateKey);
  const year = d.getUTCFullYear();
  const month = d.getUTCMonth() + 1;

  const sheet = getAttendanceSheet_(year, month);
  const allData = sheet.getDataRange().getValues();
  const TIMEZONE = "GMT+8";
  const existingRecords = {};

  for (let i = 1; i < allData.length; i++) {
    const row = allData[i];
    if (row[1] === email && row[3] === school) {
      const dateStr = Utilities.formatDate(new Date(row[4]), TIMEZONE, "yyyy-MM-dd");
      existingRecords[dateStr] = { rowIndex: i + 1 };
    }
  }

  const rowsToDelete = [];
  const rowsToUpdate = [];
  const rowsToInsert = [];

  for (const date in attendance) {
    const entry = attendance[date];
    const isEntryEmpty = !entry.checkIn && !entry.checkOut && !entry.reason;

    if (existingRecords[date]) {
      const rowIndex = existingRecords[date].rowIndex;
      if (isEntryEmpty) {
        rowsToDelete.push(rowIndex);
      } else {
        rowsToUpdate.push({
          range: `F${rowIndex}:H${rowIndex}`,
          values: [[`'${entry.checkIn || ""}`, `'${entry.checkOut || ""}`, entry.reason || ""]]
        });
      }
    } else if (!isEntryEmpty) {
      rowsToInsert.push([
        new Date(), email, name, school, new Date(date),
        `'${entry.checkIn || ""}`, `'${entry.checkOut || ""}`, entry.reason || ""
      ]);
    }
  }
  
  if (rowsToInsert.length > 0) {
    sheet.getRange(sheet.getLastRow() + 1, 1, rowsToInsert.length, rowsToInsert[0].length).setValues(rowsToInsert);
  }
  if (rowsToUpdate.length > 0) {
    rowsToUpdate.forEach(update => sheet.getRange(update.range).setValues(update.values));
  }
  if (rowsToDelete.length > 0) {
    rowsToDelete.sort((a, b) => b - a).forEach(rowIndex => sheet.deleteRow(rowIndex));
  }

  return { status: "success", message: "Absensi bulan ini berhasil diperbarui!" };
}

function getAttendanceSummary(userEmail, school, year, month) {
  try {
    const holidaysData = holidaysSheet.getDataRange().getValues().slice(1);
    const nationalHolidays = {};
    holidaysData.forEach(row => {
      if (row[0] instanceof Date && row[1]) {
        nationalHolidays[Utilities.formatDate(row[0], "GMT", "yyyy-MM-dd")] = row[1];
      }
    });
    const teacherHolidays = getTeacherHolidays(userEmail);
    const attendanceData = getMonthlyAttendance(userEmail, school, year, month);
    const daysInMonth = new Date(year, month, 0).getDate();

    let hariKerja = 0, kehadiran = 0, alpa = 0, alasanLain = 0, liburSekolah = 0;
    for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(Date.UTC(year, month - 1, day));
        const dateStr = Utilities.formatDate(dateObj, "GMT", "yyyy-MM-dd");
        const dayOfWeek = dateObj.getUTCDay();
        if (dayOfWeek === 0 || nationalHolidays[dateStr]) continue;
        hariKerja++;
        const entry = attendanceData[dateStr];
        if (entry) {
            if (entry.reason) { (entry.reason === "Hari Libur Sekolah" ? liburSekolah++ : alasanLain++); }
            else if (entry.checkIn && entry.checkOut) { kehadiran++; }
        } else if (dayOfWeek > 0 && teacherHolidays[dayOfWeek - 1]) {
            liburSekolah++;
        }
    }
    alpa = Math.max(0, hariKerja - (kehadiran + liburSekolah + alasanLain));
    const totalCeklok = kehadiran + liburSekolah + alasanLain;
    const persentase = (hariKerja > 0) ? Math.round((totalCeklok / hariKerja) * 100) : 0;
    return { success: true, summary: { hariKerja, kehadiran, alpa, alasan: liburSekolah + alasanLain, persentase, ceklok: totalCeklok } };
  } catch(e) {
    Logger.log("Error di getAttendanceSummary: " + e.message);
    return { success: false, error: e.message };
  }
}

function getSchoolAttendanceSummary(userEmail, year, month) {
  if (!checkIfAdminOrStaff(userEmail)) {
    throw new Error("Akses ditolak.");
  }
  const teachers = getSchoolTeachers(userEmail);
  const school = teachers.length > 0 ? teachers[0].school : null;
  if (!school) return [];
  
  const summaries = teachers.map(teacher => {
    const summaryResult = getAttendanceSummary(teacher.email, school, year, month);
    return {
      name: teacher.name,
      email: teacher.email,
      summary: summaryResult.success ? summaryResult.summary : {}
    };
  });
  return summaries;
}

function exportToExcel(userEmail, school, selectedMonthYear, startLockId) {
  try {
    if (!selectedMonthYear || !/^\d{4}-\d{2}$/.test(selectedMonthYear)) throw new Error("Format Bulan/Tahun tidak valid.");
    if (isNaN(parseInt(startLockId))) throw new Error("LOCK ID harus berupa angka.");
    if (!school) throw new Error("Informasi sekolah tidak ditemukan.");

    const [yearStr, monthStr] = selectedMonthYear.split('-');
    const year = parseInt(yearStr, 10);
    const month = parseInt(monthStr, 10);
    let currentLockId = parseInt(startLockId, 10);

    const attendanceData = getMonthlyAttendance(userEmail, school, year, month);
    
    const exportData = [['LOCK ID', 'TANGGAL', 'HARI', 'JAM MASUK', 'JAM PULANG', 'ALASAN TIDAK HADIR', 'DESKRIPSI']];
    const daysInMonth = new Date(year, month, 0).getDate();
    
    for (let day = 1; day <= daysInMonth; day++) {
      const currentDate = new Date(Date.UTC(year, month - 1, day));
      const tanggal = Utilities.formatDate(currentDate, "GMT", "yyyy-MM-dd");
      const hari = currentDate.toLocaleString('id-ID', { weekday: 'long', timeZone: "GMT" });
      const dailyData = attendanceData[tanggal] || {};
      
      exportData.push([
        currentLockId++, tanggal, hari, dailyData.checkIn || "", dailyData.checkOut || "", dailyData.reason || "", dailyData.reason || ""
      ]);
    }
    
    const tempSpreadsheet = SpreadsheetApp.create(`temp_export_${userEmail}_${new Date().getTime()}`);
    const tempSheet = tempSpreadsheet.getSheets()[0];
    tempSheet.getRange(1, 1, exportData.length, exportData[0].length).setValues(exportData);
    tempSheet.getRange(2, 2, exportData.length - 1, 1).setNumberFormat("@");
    tempSheet.getRange(2, 4, exportData.length - 1, 2).setNumberFormat("@");
    SpreadsheetApp.flush();
    
    const url = `https://docs.google.com/spreadsheets/d/${tempSpreadsheet.getId()}/export?format=xlsx`;
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + ScriptApp.getOAuthToken() } });
    
    const users = usersSheet.getDataRange().getValues();
    const userRow = users.find(u => u[0].toLowerCase() === userEmail.toLowerCase());
    const userName = userRow ? userRow[2] : userEmail;
    
    const bulanNama = new Date(year, month - 1, 1).toLocaleString('id-ID', { month: 'long' });
    const fileName = `EMIS_${userName.replace(/\s/g, '_')}_${school.replace(/\s/g, '_')}_${bulanNama}_${year}.xlsx`;
    const fileData = Utilities.base64Encode(response.getBlob().getBytes());

    DriveApp.getFileById(tempSpreadsheet.getId()).setTrashed(true);
    return { status: "success", fileData, fileName };

  } catch (e) {
    Logger.log("Error di exportToExcel: " + e.toString() + " | Stack: " + e.stack);
    return { status: "error", message: `Gagal membuat file Excel: ${e.message}` };
  }
}

function importFromEmis(userEmail, school, fileData) {
  let tempFileId = null;
  try {
    if (!school) throw new Error("Informasi sekolah tidak ditemukan.");
    
    const decodedData = Utilities.base64Decode(fileData.data, Utilities.Charset.UTF_8);
    const blob = Utilities.newBlob(decodedData, fileData.mimeType, fileData.fileName);
    const tempSheetFile = Drive.Files.insert({ title: `temp_import_${userEmail}_${new Date().getTime()}` }, blob, { convert: true });
    tempFileId = tempSheetFile.id;
    const sheet = SpreadsheetApp.openById(tempFileId).getSheets()[0];
    const data = sheet.getDataRange().getValues();

    if (data.length < 2) throw new Error("File Excel kosong atau tidak memiliki data.");
    
    let userFound = null;
    const users = usersSheet.getDataRange().getValues();
    for (let i = 1; i < users.length; i++) {
        if(users[i][0].toLowerCase() === userEmail.toLowerCase()) {
            userFound = { name: users[i][2] };
            break;
        }
    }
    if (!userFound) throw new Error("Data pengguna tidak ditemukan.");

    const attendancePayload = { email: userEmail, name: userFound.name, school: school, attendance: {} };
    
    const headers = data[0].map(h => String(h).trim().toUpperCase());
    const dateIndex = headers.indexOf("TANGGAL");
    const checkInIndex = headers.indexOf("JAM MASUK");
    const checkOutIndex = headers.indexOf("JAM PULANG");
    const reasonIndex = headers.indexOf("ALASAN TIDAK HADIR");

    if (dateIndex === -1 || checkInIndex === -1 || checkOutIndex === -1 || reasonIndex === -1) {
      throw new Error("Header kolom tidak sesuai. Pastikan ada: TANGGAL, JAM MASUK, JAM PULANG, ALASAN TIDAK HADIR.");
    }
    
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const dateStr = parseDateFromExcel(row[dateIndex]);
        if (!dateStr) continue;

        const checkIn = parseTimeFromExcel(row[checkInIndex]);
        const checkOut = parseTimeFromExcel(row[checkOutIndex]);
        const reason = String(row[reasonIndex] || "").trim();

        attendancePayload.attendance[dateStr] = {
            checkIn: reason ? "" : checkIn,
            checkOut: reason ? "" : checkOut,
            reason: reason
        };
    }
    
    const result = saveMonthlyAttendance(attendancePayload);
    if(result.status !== 'success') throw new Error(result.message);
    
    const firstDate = new Date(Object.keys(attendancePayload.attendance)[0]);
    return { 
        status: "success", 
        count: Object.keys(attendancePayload.attendance).length,
        year: firstDate.getUTCFullYear(),
        month: firstDate.getUTCMonth() + 1,
        monthName: firstDate.toLocaleString('id-ID', { month: 'long', timeZone: 'UTC' })
    };

  } catch (e) {
    Logger.log("Error di importFromEmis: " + e.toString() + " | Stack: " + e.stack);
    return { status: "error", message: `Gagal mengimpor: ${e.message}` };
  } finally {
    if (tempFileId) {
      try { Drive.Files.remove(tempFileId); } catch(e) {}
    }
  }
}

function parseDateFromExcel(cellValue) {
  if (cellValue instanceof Date && !isNaN(cellValue)) return Utilities.formatDate(cellValue, "GMT", "yyyy-MM-dd");
  if (typeof cellValue === 'number' && cellValue > 0) {
    const jsDate = new Date((cellValue - 25569) * 86400 * 1000);
    return Utilities.formatDate(jsDate, "GMT", "yyyy-MM-dd");
  }
  if (typeof cellValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(cellValue.trim())) return cellValue.trim();
  return null;
}

function parseTimeFromExcel(cellValue) {
  if (cellValue instanceof Date && !isNaN(cellValue)) return Utilities.formatDate(cellValue, "GMT", "HH:mm");
  if (typeof cellValue === 'number' && cellValue > 0 && cellValue < 1) {
    const dummyDate = new Date(1970, 0, 1, 0, 0, 0);
    dummyDate.setSeconds(cellValue * 86400);
    return Utilities.formatDate(dummyDate, "GMT", "HH:mm");
  }
  if (typeof cellValue === 'string' && /^\d{2}:\d{2}/.test(cellValue.trim())) return cellValue.trim().substring(0, 5);
  return "";
}

function formatTimeToHHMM_or_Empty(timeValue) {
  const TIMEZONE = "GMT+8";
  if (timeValue instanceof Date && !isNaN(timeValue)) return "'" + Utilities.formatDate(timeValue, TIMEZONE, "HH.mm");
  if (typeof timeValue === 'string' && timeValue.includes(':')) return "'" + timeValue.replace(':', '.');
  return "";
}

function generateRekapPDF(selectedMonthYear, selectedSchool, singleUserEmail) {
  let tempSheet;
  try {
    const [yyyyStr, mmStr] = selectedMonthYear.split('-');
    const yyyy = parseInt(yyyyStr, 10);
    const mm = parseInt(mmStr, 10);
    const TIMEZONE = "GMT+8";

    const attendanceSheetForMonth = getAttendanceSheet_(yyyy, mm);
    const attendanceValues = attendanceSheetForMonth.getLastRow() > 1 ? attendanceSheetForMonth.getRange(2, 1, attendanceSheetForMonth.getLastRow() - 1, 8).getValues() : [];

    const allUsers = usersSheet.getDataRange().getValues().slice(1);
    let daftarGuru, fileNameSchoolPart;

    if (singleUserEmail) {
      const guruData = allUsers.find(user => user[0].toLowerCase() === singleUserEmail.toLowerCase());
      if (!guruData) throw new Error("Data guru tidak ditemukan.");
      daftarGuru = [{ email: guruData[0], name: guruData[2], school: selectedSchool }];
      fileNameSchoolPart = `${guruData[2].replace(/\s/g, '_')}_${selectedSchool.replace(/\s/g, '_')}`;
    } else {
      daftarGuru = allUsers.filter(user => user[4] === 'guru' && (user[3] || "").split(',').map(s=>s.trim()).includes(selectedSchool))
                           .map(user => ({ email: user[0], name: user[2], school: selectedSchool }));
      
      const urutanNamaSheet = getUrutanNamaSheet_();
      const urutanData = urutanNamaSheet.getDataRange().getValues().slice(1);
      const schoolSortOrder = urutanData
        .filter(row => String(row[1]).trim() === selectedSchool)
        .map((row, index) => [String(row[0]).trim(), index]);
      const urutanMap = new Map(schoolSortOrder);
      
      daftarGuru.sort((a, b) => {
        const urutanA = urutanMap.has(String(a.name).trim()) ? urutanMap.get(String(a.name).trim()) : 999;
        const urutanB = urutanMap.has(String(b.name).trim()) ? urutanMap.get(String(b.name).trim()) : 999;
        if (urutanA !== urutanB) {
          return urutanA - urutanB;
        }
        return a.name.localeCompare(b.name);
      });

      fileNameSchoolPart = selectedSchool.replace(/\s/g, '_');
    }

    if (daftarGuru.length === 0) throw new Error(`Tidak ada data guru yang cocok.`);
    
    const rekapData = {};
    daftarGuru.forEach(g => rekapData[g.email] = {});
    
    attendanceValues.forEach(row => {
      const email = row[1];
      const school = row[3];
      if (rekapData[email] && school === selectedSchool) {
        const formattedDate = Utilities.formatDate(new Date(row[4]), TIMEZONE, "yyyy-MM-dd");
        rekapData[email][formattedDate] = {
          checkIn: formatTimeToHHMM_or_Empty(row[5]),
          checkOut: formatTimeToHHMM_or_Empty(row[6])
        };
      }
    });

    tempSheet = ss.insertSheet(`Rekap_${new Date().getTime()}`);
    const requiredColumns = 31;
    const maxColumns = tempSheet.getMaxColumns();
    if (maxColumns > requiredColumns) tempSheet.deleteColumns(requiredColumns + 1, maxColumns - requiredColumns);
    else if (maxColumns < requiredColumns) tempSheet.insertColumnsAfter(maxColumns, requiredColumns - maxColumns);
    SpreadsheetApp.flush();
    const jumlahHari = new Date(yyyy, mm, 0).getDate();
    const headerRange = tempSheet.getRange(1, 1, 1, requiredColumns);
    tempSheet.setColumnWidths(1, 31, 44);
    if (jumlahHari < 31) tempSheet.setColumnWidths(jumlahHari + 1, 31 - jumlahHari, 24);
    const tanggalAwalFormatted = Utilities.formatDate(new Date(yyyy, mm - 1, 1), TIMEZONE, "yyyy-MM-dd");
    const tanggalAkhirFormatted = Utilities.formatDate(new Date(yyyy, mm, 0), TIMEZONE, "yyyy-MM-dd");
    headerRange.merge().setValue("Lap. Detail Absensi").setHorizontalAlignment("center").setVerticalAlignment("top").setFontWeight("bold").setFontSize(14);
    tempSheet.setRowHeight(1, 60);
    tempSheet.getRange(2, 1, 1, requiredColumns).setVerticalAlignment("middle").setFontSize(11);
    tempSheet.getRange("A2").setValue(`Waktu Absensi ${tanggalAwalFormatted} ~ ${tanggalAkhirFormatted}`);
    tempSheet.getRange("L2").setValue(`Tabulansi ${tanggalAkhirFormatted}`);
    const nomorTanggalHeader = Array.from({ length: 31 }, (_, i) => (i < jumlahHari ? i + 1 : ""));
    tempSheet.getRange(3, 1, 1, 31).setValues([nomorTanggalHeader]).setHorizontalAlignment("center").setVerticalAlignment("middle").setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
    tempSheet.setRowHeight(3, 38);
    let barisSaatIni = 4;
    daftarGuru.forEach((guru, index) => {
      tempSheet.setRowHeight(barisSaatIni, 26);
      const formatSekolah = (guru.school || "").toUpperCase().replace(/ /g, "~");
      tempSheet.getRange(barisSaatIni, 1).setValue("ID:");
      tempSheet.getRange(barisSaatIni, 3).setValue(index + 1);
      tempSheet.getRange(barisSaatIni, 9).setValue("Nama:");
      tempSheet.getRange(barisSaatIni, 11).setValue(guru.name);
      tempSheet.getRange(barisSaatIni, 19).setValue("Dept.:");
      tempSheet.getRange(barisSaatIni, 21).setValue(formatSekolah);
      const arrayJamMasuk = [], arrayJamPulang = [];
      for (let tgl = 1; tgl <= 31; tgl++) {
        let jamMasuk = "", jamPulang = "";
        if (tgl <= jumlahHari) {
          const tglStr = `${yyyy}-${String(mm).padStart(2, '0')}-${String(tgl).padStart(2, '0')}`;
          const dataHarian = rekapData[guru.email] ? rekapData[guru.email][tglStr] : null;
          if (dataHarian) { jamMasuk = dataHarian.checkIn; jamPulang = dataHarian.checkOut; }
        }
        arrayJamMasuk.push(jamMasuk);
        arrayJamPulang.push(jamPulang);
      }
      tempSheet.setRowHeight(barisSaatIni + 1, 18);
      tempSheet.setRowHeight(barisSaatIni + 2, 18);
      tempSheet.getRange(barisSaatIni + 1, 1, 1, 31).setValues([arrayJamMasuk]);
      tempSheet.getRange(barisSaatIni + 2, 1, 1, 31).setValues([arrayJamPulang]);
      const blockRange = tempSheet.getRange(barisSaatIni, 1, 3, 31);
      blockRange.setVerticalAlignment("middle").setHorizontalAlignment("center");
      tempSheet.getRange(barisSaatIni, 1).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 9).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 11).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 19).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 21).setHorizontalAlignment("left");
      const infoRowRange = tempSheet.getRange(barisSaatIni, 1, 1, 31);
      const dataRowsRange = tempSheet.getRange(barisSaatIni + 1, 1, 2, 31);
      infoRowRange.setBorder(true, true, true, true, false, false, '#000000', SpreadsheetApp.BorderStyle.SOLID);
      dataRowsRange.setBorder(null, true, true, true, true, false, '#000000', SpreadsheetApp.BorderStyle.SOLID);
      barisSaatIni += 3;
    });
    SpreadsheetApp.flush();
    const spreadsheetId = ss.getId();
    const sheetId = tempSheet.getSheetId();
    const bulanNama = new Date(yyyy, mm - 1, 1).toLocaleString('id-ID', { month: 'long' });
    const fileName = `Absensi_${fileNameSchoolPart}_${bulanNama.toUpperCase()}_${yyyy}.pdf`;
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=pdf&gid=${sheetId}&size=A4&portrait=false&fitw=true&top_margin=0.39&bottom_margin=0.39&left_margin=0.39&right_margin=0.39&gridlines=false&printnotes=false&horizontal_alignment=CENTER&vertical_alignment=TOP`;
    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
    const pdfData = Utilities.base64Encode(response.getBlob().getBytes());
    return { success: true, pdfData, fileName };

  } catch (e) {
    Logger.log(`Error di generateRekapPDF: ${e.toString()} \nStack: ${e.stack}`);
    return { success: false, error: `Gagal membuat PDF: ${e.message}` };
  } finally {
    if (tempSheet) {
      ss.deleteSheet(tempSheet);
    }
  }
}

function prepareMonthlyRekapForPrint(adminEmail, selectedMonthYear, selectedSchool) {
  if (!checkIfAdmin(adminEmail)) return { success: false, error: "Akses ditolak." };
  return generateRekapPDF(selectedMonthYear, selectedSchool, null);
}

function prepareMyRekapForPrint(userEmail, school, selectedMonthYear) {
  if (!userEmail || !school) return { success: false, error: "Sesi tidak valid." };
  return generateRekapPDF(selectedMonthYear, school, userEmail);
}

function prepareSchoolRekapForPrint(userEmail, selectedMonthYear, selectedSchool) {
  if (!userEmail) return { success: false, error: "Sesi tidak valid." };
  return generateRekapPDF(selectedMonthYear, selectedSchool, null);
}

function getUsers(adminEmail) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const users = usersSheet.getDataRange().getValues().slice(1);
  return users.map(user => ({email: user[0], password: user[1], name: user[2], school: user[3], role: user[4]}));
}

function addUser(adminEmail, userData) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const usersData = usersSheet.getDataRange().getValues();
  const emailExists = usersData.some(row => row[0].toLowerCase() === userData.email.toLowerCase());
  if (emailExists) {
    return { status: "error", message: "Email sudah terdaftar." };
  }
  usersSheet.appendRow([userData.email, userData.password, userData.name, userData.school, userData.role]);
  return { status: "success", message: "User berhasil ditambah." };
}

function updateUser(adminEmail, userData) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === userData.originalEmail) {
      usersSheet.getRange(i + 1, 1, 1, 5).setValues([[userData.email, userData.password, userData.name, userData.school, userData.role]]);
      return { status: "success", message: "User berhasil diperbarui." };
    }
  }
  return { status: "error", message: "User tidak ditemukan." };
}

function deleteUser(adminEmail, emailToDelete) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === emailToDelete) {
      usersSheet.deleteRow(i + 1);
      return { status: "success", message: "User berhasil dihapus." };
    }
  }
  return { status: "error", message: "User tidak ditemukan." };
}

function getSettings(adminEmail) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  let lockedMonths = "[]";
  try {
    const settingsData = settingsSheet.getDataRange().getValues();
    settingsData.forEach(row => { if (row[0] === 'locked_months') lockedMonths = row[1]; });
  } catch (e) {}
  let holidays = [];
  try {
    const holidaysData = holidaysSheet.getDataRange().getValues().slice(1);
    holidays = holidaysData.map(row => ({ date: Utilities.formatDate(new Date(row[0]), "GMT", "yyyy-MM-dd"), description: row[1] })).filter(h => h.description);
  } catch (e) {}
  const announcements = getAnnouncements();
  return { lockedMonths: JSON.parse(lockedMonths), holidays: holidays, announcements: announcements };
}

function saveLockedMonths(adminEmail, months) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  settingsSheet.clearContents();
  settingsSheet.appendRow(["Key", "Value"]);
  settingsSheet.appendRow(["locked_months", JSON.stringify(months)]);
  return { status: "success", message: "Bulan terkunci berhasil disimpan." };
}

function saveHolidays(adminEmail, holidays) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  holidaysSheet.getRange("A2:B").clearContent();
  if (holidays.length > 0) {
    const rows = holidays.map(h => [new Date(h.date), h.description]);
    holidaysSheet.getRange(2, 1, rows.length, 2).setValues(rows);
  }
  return { status: "success", message: "Hari libur berhasil disimpan." };
}

function getAnnouncements() {
  try {
    return announcementsSheet.getRange("A1").getValue() || "";
  } catch (e) { return ""; }
}

function saveAnnouncements(adminEmail, announcementText) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  try {
    announcementsSheet.getRange("A1").setValue(announcementText);
    return { status: "success", message: "Pengumuman berhasil diperbarui." };
  } catch (e) { return { status: "error", message: e.message }; }
}

function getSchoolList(adminEmail) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const usersData = usersSheet.getDataRange().getValues().slice(1);
  const allSchools = usersData.flatMap(row => (row[3] || "").split(',').map(s => s.trim()));
  return [...new Set(allSchools)].filter(Boolean);
}

function getSchoolTeachers(userEmail) {
  if (!checkIfAdminOrStaff(userEmail)) throw new Error("Akses ditolak.");
  const allUsers = usersSheet.getDataRange().getValues();
  const currentUserRow = allUsers.find(u => u[0].toLowerCase() === userEmail.toLowerCase());
  if (!currentUserRow) throw new Error("Pengguna tidak ditemukan.");
  
  const userPrimarySchool = (currentUserRow[3] || "").split(',')[0].trim();
  
  const teachers = allUsers.slice(1)
    .filter(user => user[4] === 'guru' && (user[3] || "").split(',').map(s => s.trim()).includes(userPrimarySchool))
    .map(user => ({ email: user[0], name: user[2], school: userPrimarySchool }));
    
  const urutanNamaSheet = getUrutanNamaSheet_();
  const urutanData = urutanNamaSheet.getDataRange().getValues().slice(1);
  const schoolSortOrder = urutanData
    .filter(row => String(row[1]).trim() === userPrimarySchool)
    .map((row, index) => [String(row[0]).trim(), index]);
  const urutanMap = new Map(schoolSortOrder);
    
  teachers.sort((a, b) => {
    const urutanA = urutanMap.has(String(a.name).trim()) ? urutanMap.get(String(a.name).trim()) : 999;
    const urutanB = urutanMap.has(String(b.name).trim()) ? urutanMap.get(String(b.name).trim()) : 999;
    if (urutanA !== urutanB) {
      return urutanA - urutanB;
    }
    return a.name.localeCompare(b.name);
  });
  
  return teachers;
}

function getTeacherHolidays(email) {
  if (!email) return Array(6).fill(false);
  try {
    const data = teacherHolidaysSheet.getDataRange().getValues();
    const userRow = data.find(row => row[0].toLowerCase() === email.toLowerCase());
    return userRow ? userRow.slice(1, 7) : Array(6).fill(false);
  } catch (e) {
    return Array(6).fill(false);
  }
}

function saveTeacherHolidays(email, settings) {
  if (!email || !Array.isArray(settings) || settings.length !== 6) {
    throw new Error("Data tidak valid.");
  }
  try {
    const data = teacherHolidaysSheet.getDataRange().getValues();
    let rowIndex = -1;
    for(let i = 0; i < data.length; i++) {
      if(data[i][0].toLowerCase() === email.toLowerCase()) {
        rowIndex = i + 1;
        break;
      }
    }
    const valuesToSave = [email, ...settings];
    if (rowIndex > 0) {
      teacherHolidaysSheet.getRange(rowIndex, 1, 1, 7).setValues([valuesToSave]);
    } else {
      teacherHolidaysSheet.appendRow(valuesToSave);
    }
    return { status: "success", message: "Pengaturan hari libur berhasil disimpan." };
  } catch (e) {
    return { status: "error", message: e.message };
  }
}

function sendIncompleteAttendanceReminders() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth() + 1;
  const lastDayOfMonth = new Date(year, month, 0).getDate();
  const remainingDays = lastDayOfMonth - today.getDate();

  const reminderDays = [5, 3, 2, 1];
  if (!reminderDays.includes(remainingDays)) return;

  const allUsers = usersSheet.getDataRange().getValues().slice(1);
  const teachers = allUsers.filter(user => user[4] === 'guru');

  teachers.forEach(teacher => {
    const teacherEmail = teacher[0];
    const teacherName = teacher[2];
    const teacherSchools = (teacher[3] || "").split(',').map(s => s.trim()).filter(Boolean);

    teacherSchools.forEach(school => {
      const summaryResult = getAttendanceSummary(teacherEmail, school, year, month);
      if (summaryResult.success && summaryResult.summary.persentase < 100) {
        const subject = `Peringatan: Pengisian Ceklok di ${school} Belum Lengkap`;
        const summary = summaryResult.summary;
        const body = `<p>Halo ${teacherName},</p><p>Sistem kami mendeteksi bahwa pengisian ceklok kehadiran Anda untuk <strong>${school}</strong> bulan ini belum mencapai 100%.</p><p>Mohon segera melengkapi data Anda. Ringkasan saat ini: ${summary.persentase}% lengkap.</p>`;
        
        try {
          MailApp.sendEmail({ to: teacherEmail, subject: subject, htmlBody: body, name: "Sistem Ceklok Otomatis" });
        } catch (e) {
          Logger.log(`Gagal kirim email ke ${teacherEmail} untuk ${school}: ${e.message}`);
        }
      }
    });
  });
}

function setupDailyTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'sendIncompleteAttendanceReminders') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  ScriptApp.newTrigger('sendIncompleteAttendanceReminders')
    .timeBased()
    .everyDays(1)
    .atHour(8)
    .create();
  Logger.log('Trigger harian untuk pengingat email berhasil dibuat.');
}
