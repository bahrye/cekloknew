/**
 * ===================================================================
 * APLIKASI CEKLOK GURU & ADMIN
 * Backend Google Apps Script (Kode.gs) - VERSI FINAL
 *
 * FITUR:
 * - Login untuk Guru & Admin
 * - Dasbor Guru & Admin
 * - Pengisian Absensi Bulanan oleh Guru
 * - Manajemen Akun oleh Admin (CRUD)
 * - Pengaturan Aplikasi oleh Admin (Pengumuman, Kunci Absen, Hari Libur)
 * - Unduh Rekap PDF Otomatis (Admin & Guru)
 * - Menggunakan Sheet Sementara untuk Unduhan Simultan yang Aman (Tanpa Konflik)
 * - Penyesuaian Lebar Kolom Otomatis pada Laporan
 * ===================================================================
 */

// --- KONFIGURASI GLOBAL ---
const SPREADSHEET_ID = "1EIQY1DeGcwhEaYojbGMah-S5HbtsrON5YRy37bl_vLg"; 

const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
const usersSheet = ss.getSheetByName("Users");
const attendanceSheet = ss.getSheetByName("Attendance");
const settingsSheet = ss.getSheetByName("Settings");
const holidaysSheet = ss.getSheetByName("Holidays");
const announcementsSheet = ss.getSheetByName("Announcements");

// --- FUNGSI UTAMA & TAMPILAN ---

function doGet() {
  return HtmlService.createTemplateFromFile('index').evaluate()
      .setTitle("Aplikasi Ceklok Guru & Admin")
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI KEAMANAN & OTENTIKASI ---

function checkIfAdmin(email) {
  if (!email) return false;
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0].toLowerCase() === email.toLowerCase()) {
      return users[i][4] === 'admin';
    }
  }
  return false;
}

function userLogin(email, password) {
  try {
    const users = usersSheet.getDataRange().getValues();
    for (let i = 1; i < users.length; i++) {
      if (users[i][0].toLowerCase() === email.toLowerCase() && users[i][1] == password && users[i][4]) { 
        return { 
          status: "success", 
          email: users[i][0],
          name: users[i][2], 
          school: users[i][3],
          role: users[i][4]
        };
      }
    }
    return { status: "failed", message: "Email, password salah, atau Anda tidak memiliki peran." };
  } catch(e) {
    return { status: "error", message: e.message };
  }
}

// --- FUNGSI UNTUK TAMPILAN GURU ---

function getAppSettingsForUser(email, year, month) {
  const attendanceData = getMonthlyAttendance(email, year, month);
  let lockedMonths = [];
  try {
    const settingsData = settingsSheet.getDataRange().getValues();
    settingsData.forEach(row => {
      if (row[0] === 'locked_months' && row[1]) {
        lockedMonths = JSON.parse(row[1]);
      }
    });
  } catch (e) {}
  
  const today = new Date();
  if (today.getDate() > 10) {
    const lastMonthDate = new Date();
    lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
    const lastMonthStr = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
    if (!lockedMonths.includes(lastMonthStr)) {
      lockedMonths.push(lastMonthStr);
    }
  }

  const holidays = {};
  try {
    const holidaysData = holidaysSheet.getDataRange().getValues().slice(1);
    holidaysData.forEach(row => {
      if (row[0] instanceof Date && row[1]) {
        holidays[Utilities.formatDate(row[0], "GMT", "yyyy-MM-dd")] = row[1];
      }
    });
  } catch (e) {}

  const announcements = getAnnouncements();
  return { attendance: attendanceData, lockedMonths: lockedMonths, holidays: holidays, announcements: announcements };
}

function saveMonthlyAttendance(payload) {
  const { email, name, school, attendance } = payload;
  const allData = attendanceSheet.getDataRange().getValues();
  const TIMEZONE = "GMT+8";
  const existingRecords = {};
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][1] === email && allData[i][4] instanceof Date) {
      existingRecords[Utilities.formatDate(allData[i][4], TIMEZONE, "yyyy-MM-dd")] = { rowIndex: i + 1 };
    }
  }
  for (const date in attendance) {
    const entry = attendance[date];
    const checkInDateTime = entry.checkIn ? new Date(`${date}T${entry.checkIn}:00`) : null;
    const checkOutDateTime = entry.checkOut ? new Date(`${date}T${entry.checkOut}:00`) : null;
    const reason = entry.reason || null;
    if (existingRecords[date]) {
      attendanceSheet.getRange(existingRecords[date].rowIndex, 6, 1, 3).setValues([[checkInDateTime, checkOutDateTime, reason]]);
    } else if (checkInDateTime || checkOutDateTime || reason) {
      attendanceSheet.appendRow([new Date(), email, name, school, new Date(date), checkInDateTime, checkOutDateTime, reason]);
    }
  }
  return { status: "success", message: "Absensi bulan ini berhasil diperbarui!" };
}

function getMonthlyAttendance(email, year, month) {
  const attendanceData = {};
  const data = attendanceSheet.getDataRange().getValues();
  const TIMEZONE = "GMT+8";
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[1] === email && row[4] instanceof Date) {
      const rowDateObj = row[4];
      if (rowDateObj.getFullYear() === year && (rowDateObj.getMonth() + 1) === month) {
        const formattedDate = Utilities.formatDate(rowDateObj, TIMEZONE, "yyyy-MM-dd");
        attendanceData[formattedDate] = {
          checkIn: row[5] instanceof Date ? Utilities.formatDate(row[5], TIMEZONE, "HH:mm") : "",
          checkOut: row[6] instanceof Date ? Utilities.formatDate(row[6], TIMEZONE, "HH:mm") : "",
          reason: row[7] || ""
        };
      }
    }
  }
  return attendanceData;
}

// --- FUNGSI KHUSUS PANEL ADMIN ---

function getUsers(adminEmail) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const users = usersSheet.getDataRange().getValues().slice(1);
  return users.map(user => ({email: user[0], password: user[1], name: user[2], school: user[3], role: user[4]}));
}

function addUser(adminEmail, userData) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  usersSheet.appendRow([userData.email, userData.password, userData.name, userData.school, userData.role]);
  return { status: "success", message: "User berhasil ditambah." };
}

function updateUser(adminEmail, userData) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === userData.originalEmail) {
      usersSheet.getRange(i + 1, 1, 1, 5).setValues([[userData.email, userData.password, userData.name, userData.school, userData.role]]);
      return { status: "success", message: "User berhasil diperbarui." };
    }
  }
  return { status: "error", message: "User tidak ditemukan." };
}

function deleteUser(adminEmail, emailToDelete) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const users = usersSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === emailToDelete) {
      usersSheet.deleteRow(i + 1);
      return { status: "success", message: "User berhasil dihapus." };
    }
  }
  return { status: "error", message: "User tidak ditemukan." };
}

function getSettings(adminEmail) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  let lockedMonths = "[]";
  try {
    const settingsData = settingsSheet.getDataRange().getValues();
    settingsData.forEach(row => { if (row[0] === 'locked_months') lockedMonths = row[1]; });
  } catch (e) {}
  let holidays = [];
  try {
    const holidaysData = holidaysSheet.getDataRange().getValues().slice(1);
    holidays = holidaysData.map(row => ({ date: Utilities.formatDate(new Date(row[0]), "GMT", "yyyy-MM-dd"), description: row[1] })).filter(h => h.description);
  } catch (e) {}
  const announcements = getAnnouncements();
  return { lockedMonths: JSON.parse(lockedMonths), holidays: holidays, announcements: announcements };
}

function saveLockedMonths(adminEmail, months) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  settingsSheet.clearContents();
  settingsSheet.appendRow(["Key", "Value"]);
  settingsSheet.appendRow(["locked_months", JSON.stringify(months)]);
  return { status: "success", message: "Bulan terkunci berhasil disimpan." };
}

function saveHolidays(adminEmail, holidays) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  if (holidaysSheet.getLastRow() > 1) {
    holidaysSheet.deleteRows(2, holidaysSheet.getLastRow() - 1);
  }
  if (holidays.length > 0) {
    const rows = holidays.map(h => [new Date(h.date), h.description]);
    holidaysSheet.getRange(2, 1, rows.length, 2).setValues(rows);
  }
  return { status: "success", message: "Hari libur berhasil disimpan." };
}

function getAnnouncements() {
  try {
    const data = announcementsSheet.getRange("A1").getValue();
    return data || "";
  } catch (e) { return ""; }
}

function saveAnnouncements(adminEmail, announcementText) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  try {
    announcementsSheet.clearContents();
    announcementsSheet.getRange("A1").setValue(announcementText);
    return { status: "success", message: "Pengumuman berhasil diperbarui." };
  } catch (e) { return { status: "error", message: e.message }; }
}

// --- FUNGSI UNTUK REKAP LAPORAN PDF ---

function getSchoolList(adminEmail) {
  if (!checkIfAdmin(adminEmail)) throw new Error("Akses ditolak.");
  const usersData = usersSheet.getDataRange().getValues().slice(1);
  return [...new Set(usersData.map(row => row[3]))].filter(Boolean);
}

function formatTimeToHHMM_or_Empty(dateObj) {
  const TIMEZONE = "GMT+8";
  if (dateObj instanceof Date && !isNaN(dateObj)) {
    return Utilities.formatDate(dateObj, TIMEZONE, "HH:mm");
  }
  return "";
}

function prepareMonthlyRekapForPrint(adminEmail, selectedMonthYear, selectedSchool) {
  if (!checkIfAdmin(adminEmail)) return { success: false, error: "Akses ditolak." };
  return generateRekapPDF(selectedMonthYear, selectedSchool, null);
}

function prepareMyRekapForPrint(userEmail, selectedMonthYear) {
  if (!userEmail) return { success: false, error: "Sesi tidak valid." };
  return generateRekapPDF(selectedMonthYear, null, userEmail);
}

function prepareSchoolRekapForPrint(userEmail, selectedMonthYear, selectedSchool) {
  if (!userEmail) return { success: false, error: "Sesi tidak valid." };
  return generateRekapPDF(selectedMonthYear, selectedSchool, null);
}

/**
 * FUNGSI INTI PENGHASIL PDF (DIGUNAKAN BERSAMA)
 * Membuat laporan di sheet sementara, menghasilkan PDF, lalu menghapus sheet.
 * --- VERSI DENGAN FORMAT FINAL ---
 */
function generateRekapPDF(selectedMonthYear, selectedSchool, singleUserEmail) {
  let tempSheet;
  try {
    if (!selectedMonthYear || !/^\d{4}-\d{2}$/.test(selectedMonthYear)) {
      return { success: false, error: "Format Bulan/Tahun tidak valid." };
    }
    const [yyyyStr, mmStr] = selectedMonthYear.split('-');
    const mm = parseInt(mmStr, 10);
    const yyyy = parseInt(yyyyStr, 10);
    const TIMEZONE = "GMT+8";
    
    tempSheet = ss.insertSheet(`Rekap_${new Date().getTime()}`);

    const requiredColumns = 31;
    const maxColumns = tempSheet.getMaxColumns();
    if (maxColumns < requiredColumns) {
      tempSheet.insertColumnsAfter(maxColumns, requiredColumns - maxColumns);
    }

    const allUsers = usersSheet.getDataRange().getValues().slice(1);
    let daftarGuru, fileNameSchoolPart;

    if (singleUserEmail) {
      const guruData = allUsers.find(user => user[0].toLowerCase() === singleUserEmail.toLowerCase());
      if (!guruData) throw new Error("Data guru tidak ditemukan.");
      daftarGuru = [{ email: guruData[0], name: guruData[2], school: guruData[3] }];
      fileNameSchoolPart = guruData[2];
    } else {
      if (!selectedSchool) throw new Error("Sekolah wajib dipilih.");
      daftarGuru = allUsers.filter(user => user[4] === 'guru' && user[3] === selectedSchool)
                           .map(user => ({ email: user[0], name: user[2], school: user[3] }));
      fileNameSchoolPart = selectedSchool;
    }

    if (daftarGuru.length === 0) throw new Error(`Tidak ada data guru yang cocok.`);

    const attendanceValues = attendanceSheet.getDataRange().getValues().slice(1);
    const rekapData = {};
    attendanceValues.forEach(row => {
      const email = row[1]; const dateObj = row[4];
      if (dateObj instanceof Date && dateObj.getFullYear() === yyyy && (dateObj.getMonth() + 1) === mm) {
        const formattedDate = Utilities.formatDate(dateObj, TIMEZONE, "yyyy-MM-dd");
        if (!rekapData[email]) rekapData[email] = {};
        rekapData[email][formattedDate] = {
          checkIn: formatTimeToHHMM_or_Empty(row[5]),
          checkOut: formatTimeToHHMM_or_Empty(row[6])
        };
      }
    });
    
    const jumlahHari = new Date(yyyy, mm, 0).getDate();
    tempSheet.setColumnWidths(1, 31, 38);
    if (jumlahHari < 31) tempSheet.setColumnWidths(jumlahHari + 1, 31 - jumlahHari, 26);
    
    const tanggalAwalObj = new Date(yyyy, mm - 1, 1);
    const tanggalAwalFormatted = Utilities.formatDate(tanggalAwalObj, TIMEZONE, "yyyy-MM-dd");
    const tanggalAkhirFormatted = Utilities.formatDate(new Date(yyyy, mm, 0), TIMEZONE, "yyyy-MM-dd");
    
    // Header Utama
    tempSheet.getRange("A1:AE1").merge();
    tempSheet.getRange("A1").setValue("Lap. Detail Absensi").setHorizontalAlignment("center").setVerticalAlignment("top").setFontWeight("bold").setFontSize(14);
    tempSheet.setRowHeight(1, 60); // Mengatur tinggi baris header utama
    
    // Sub-Header
    tempSheet.getRange("A2:AE2").setVerticalAlignment("middle").setFontSize(11);
    tempSheet.getRange("A2").setValue(`Waktu Absensi ${tanggalAwalFormatted} ~ ${tanggalAkhirFormatted}`);
    tempSheet.getRange("L2").setValue(`Tabulansi ${tanggalAkhirFormatted}`);
    
    // Header Tanggal
    const nomorTanggalHeader = Array.from({ length: 31 }, (_, i) => (i < jumlahHari ? i + 1 : ""));
    tempSheet.getRange(3, 1, 1, 31).setValues([nomorTanggalHeader]).setHorizontalAlignment("center").setVerticalAlignment("middle").setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
    tempSheet.setRowHeight(3, 38); // Mengatur tinggi baris tanggal
    
    let barisSaatIni = 4;
    daftarGuru.forEach((guru, index) => {
      // Baris Info Guru
      tempSheet.setRowHeight(barisSaatIni, 26); // Mengatur tinggi baris ID
      const formatSekolah = (guru.school || "").toUpperCase().replace(/ /g, "~");
      tempSheet.getRange(barisSaatIni, 1).setValue("ID:");
      tempSheet.getRange(barisSaatIni, 3).setValue(index + 1);
      tempSheet.getRange(barisSaatIni, 9).setValue("Nama:");
      tempSheet.getRange(barisSaatIni, 11).setValue(guru.name);
      tempSheet.getRange(barisSaatIni, 19).setValue("Dept.:");
      tempSheet.getRange(barisSaatIni, 21).setValue(formatSekolah);
      
      const arrayJamMasuk = [], arrayJamPulang = [];
      for (let tgl = 1; tgl <= 31; tgl++) {
        let jamMasuk = "", jamPulang = "";
        if (tgl <= jumlahHari) {
          const tglStr = `${yyyy}-${String(mm).padStart(2, '0')}-${String(tgl).padStart(2, '0')}`;
          const dataHarian = rekapData[guru.email] ? rekapData[guru.email][tglStr] : null;
          if (dataHarian) { jamMasuk = dataHarian.checkIn; jamPulang = dataHarian.checkOut; }
        }
        arrayJamMasuk.push(jamMasuk);
        arrayJamPulang.push(jamPulang);
      }
      
      // Baris Data Absensi
      tempSheet.setRowHeight(barisSaatIni + 1, 18); // Mengatur tinggi baris jam masuk
      tempSheet.setRowHeight(barisSaatIni + 2, 18); // Mengatur tinggi baris jam pulang
      tempSheet.getRange(barisSaatIni + 1, 1, 1, 31).setValues([arrayJamMasuk]);
      tempSheet.getRange(barisSaatIni + 2, 1, 1, 31).setValues([arrayJamPulang]);
      
      // Pengaturan Format & Border
      const blockRange = tempSheet.getRange(barisSaatIni, 1, 3, 31);
      blockRange.setVerticalAlignment("middle").setHorizontalAlignment("center");
      tempSheet.getRange(barisSaatIni, 1).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 9).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 11).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 19).setHorizontalAlignment("left");
      tempSheet.getRange(barisSaatIni, 21).setHorizontalAlignment("left");
      
      const infoRowRange = tempSheet.getRange(barisSaatIni, 1, 1, 31);
      const dataRowsRange = tempSheet.getRange(barisSaatIni + 1, 1, 2, 31);
      infoRowRange.setBorder(true, true, true, true, false, false, '#000000', SpreadsheetApp.BorderStyle.SOLID);
      dataRowsRange.setBorder(null, true, true, true, true, false, '#000000', SpreadsheetApp.BorderStyle.SOLID);
      barisSaatIni += 3;
    });
    
    SpreadsheetApp.flush();

    const spreadsheetId = ss.getId();
    const sheetId = tempSheet.getSheetId();
    const bulanNama = new Date(yyyy, mm - 1, 1).toLocaleString('id-ID', { month: 'long' });
    const fileName = `Absensi ${fileNameSchoolPart} - ${bulanNama.toUpperCase()} ${yyyy}.pdf`;
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=pdf&gid=${sheetId}&size=A4&scale=4&top_margin=0.393701&bottom_margin=0.393701&left_margin=0.393701&right_margin=0.393701&gridlines=false&printnotes=false&horizontal_alignment=CENTER&vertical_alignment=TOP`;
    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
    const blob = response.getBlob().setName(fileName);
    const pdfData = Utilities.base64Encode(blob.getBytes());

    return { success: true, pdfData, fileName };

  } catch (e) {
    Logger.log(`Error di generateRekapPDF: ${e.toString()}`);
    return { success: false, error: `Gagal membuat PDF: ${e.message}` };
  } finally {
    if (tempSheet) {
      ss.deleteSheet(tempSheet);
    }
  }
}
