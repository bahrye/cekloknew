// Ganti dengan ID Google Sheet Anda
const SPREADSHEET_ID = "1EIQY1DeGcwhEaYojbGMah-S5HbtsrON5YRy37bl_vLg"; 
const usersSheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Users");
const attendanceSheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Attendance");

function doGet() {
  return HtmlService.createTemplateFromFile('index').evaluate()
      .setTitle("Aplikasi Ceklok Guru")
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function userLogin(email, password) {
  try {
    const users = usersSheet.getDataRange().getValues();
    for (let i = 1; i < users.length; i++) {
      if (users[i][0].toLowerCase() === email.toLowerCase() && users[i][1] == password) { 
        return { 
          status: "success", 
          email: users[i][0],
          name: users[i][2], 
          school: users[i][3] 
        };
      }
    }
    return { status: "failed", message: "Email atau password salah." };
  } catch(e) {
    return { status: "error", message: e.message };
  }
}

function getMonthlyAttendance(email, year, month) {
  const attendanceData = {};
  const data = attendanceSheet.getDataRange().getValues();
  const TIMEZONE = "GMT+8";

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const rowEmail = row[1];
    const rowDateObj = row[4];

    if (rowEmail !== email || !(rowDateObj instanceof Date)) {
      continue;
    }

    if (rowDateObj.getFullYear() === year && (rowDateObj.getMonth() + 1) === month) {
      
      const formattedDate = Utilities.formatDate(rowDateObj, TIMEZONE, "yyyy-MM-dd");
      
      const checkInTime = row[5] instanceof Date ? Utilities.formatDate(row[5], TIMEZONE, "HH:mm") : "";
      const checkOutTime = row[6] instanceof Date ? Utilities.formatDate(row[6], TIMEZONE, "HH:mm") : "";
      const reason = row[7] || "";
      
      attendanceData[formattedDate] = {
        checkIn: checkInTime,
        checkOut: checkOutTime,
        reason: reason
      };
    }
  }
  return attendanceData;
}

/**
 * MENYIMPAN DATA ABSENSI BULANAN (VERSI PERBAIKAN)
 * @param {object} payload - Berisi email, nama, sekolah, dan data absensi.
 * @returns {object} - Status penyimpanan.
 */
function saveMonthlyAttendance(payload) {
  const { email, name, school, attendance } = payload;
  const allData = attendanceSheet.getDataRange().getValues();
  const TIMEZONE = "GMT+8";

  const existingRecords = {};
  for (let i = 1; i < allData.length; i++) {
    if(allData[i][1] === email && allData[i][4] instanceof Date) {
      const rowDate = Utilities.formatDate(allData[i][4], TIMEZONE, "yyyy-MM-dd");
      existingRecords[rowDate] = { rowIndex: i + 1 };
    }
  }

  for (const date in attendance) {
    const entry = attendance[date];
    
    // Siapkan data, akan menjadi null jika string-nya kosong
    const checkInDateTime = entry.checkIn ? new Date(`${date}T${entry.checkIn}:00`) : null;
    const checkOutDateTime = entry.checkOut ? new Date(`${date}T${entry.checkOut}:00`) : null;
    const reason = entry.reason || null;

    if (existingRecords[date]) {
      // Data sudah ada, perbarui baris yang ada.
      // setValue(null) akan MENGOSONGKAN sel di spreadsheet.
      const rowIndex = existingRecords[date].rowIndex;
      attendanceSheet.getRange(rowIndex, 6, 1, 3).setValues([[checkInDateTime, checkOutDateTime, reason]]);

    } else if (checkInDateTime || checkOutDateTime || reason) {
      // Data belum ada DAN ada isinya, maka buat baris baru.
      // Ini mencegah pembuatan baris kosong.
      const newRow = [
        new Date(),
        email,
        name,
        school,
        new Date(date),
        checkInDateTime,
        checkOutDateTime,
        reason
      ];
      attendanceSheet.appendRow(newRow);
    }
  }

  return { status: "success", message: "Absensi bulan ini berhasil diperbarui!" };
}
