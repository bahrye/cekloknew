<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('style'); ?>
  </head>
  <body>
    <div class="container">
      <div id="login-container">
        <div class="card">
          <h2>üîê Ceklok Guru</h2>
          <p>Silakan login untuk melanjutkan</p>
          <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Masukkan email Anda">
          </div>
          <div class="input-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Masukkan password">
          </div>
          <button onclick="handleLogin()">Login</button>
          <p id="login-message" class="message"></p>
        </div>
      </div>

      <div id="dashboard-container" style="display:none;">
        <div class="card">
          <h2 id="welcome-message"></h2>
          
          <div class="month-navigator">
            <button onclick="changeMonth(-1)">&#9664; Bulan Lalu</button>
            <h3 id="month-display"></h3>
            <button onclick="changeMonth(1)">Bulan Depan &#9654;</button>
          </div>

          <div id="attendance-table-container">
             </div>

          <button onclick="handleSave()">Simpan Semua Perubahan</button>
          <button class="logout" onclick="handleLogout()">Logout</button>
          <p id="save-message" class="message"></p>
        </div>
      </div>

    </div>
    
    <script>
      let currentUser = null;
      let currentDate = new Date();

      document.addEventListener('DOMContentLoaded', () => {
        const userSession = sessionStorage.getItem('ceklokUser');
        if (userSession) {
          currentUser = JSON.parse(userSession);
          showDashboard(currentUser);
        }
      });

      function handleLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const button = event.target;
        if (!email || !password) {
          document.getElementById('login-message').innerText = "Email dan password wajib diisi.";
          return;
        }
        button.disabled = true;
        button.textContent = "Mencoba Login...";
        document.getElementById('login-message').innerText = "";
        google.script.run.withSuccessHandler(response => {
            if (response.status === "success") {
              sessionStorage.setItem('ceklokUser', JSON.stringify(response));
              currentUser = response;
              showDashboard(response);
            } else {
              document.getElementById('login-message').innerText = response.message;
              button.disabled = false;
              button.textContent = "Login";
            }
          }).withFailureHandler(error => {
            document.getElementById('login-message').innerText = "Error: " + error.message;
            button.disabled = false;
            button.textContent = "Login";
          }).userLogin(email, password);
      }

      function showDashboard(userData) {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("dashboard-container").style.display = "block";
        document.getElementById("welcome-message").innerHTML = `Halo, <strong>${userData.name}</strong><br><small>${userData.school}</small>`;
        loadAttendanceForMonth(currentDate);
      }

      function loadAttendanceForMonth(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        document.getElementById('month-display').innerText = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
        const container = document.getElementById('attendance-table-container');
        container.innerHTML = '<div class="spinner">Memuat data...</div>';
        generateMonthTable(year, month);
        google.script.run
          .withSuccessHandler(attendanceData => {
            populateAttendanceData(attendanceData);
          })
          .getMonthlyAttendance(currentUser.email, year, month);
      }

      function generateMonthTable(year, month) {
        const container = document.getElementById('attendance-table-container');
        const daysInMonth = new Date(year, month, 0).getDate();
        
        let tableHTML = '<table><thead><tr><th>Tanggal</th><th>Jam Masuk</th><th>Jam Pulang</th><th>Alasan</th><th>Aksi</th></tr></thead><tbody>';
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dateObj = new Date(year, month - 1, day);
          const dayName = dateObj.toLocaleDateString('id-ID', { weekday: 'short' });
          const isSunday = dateObj.getDay() === 0;
          const rowClass = isSunday ? 'class="sunday-row"' : '';
          const isDisabled = isSunday ? 'disabled' : '';

          tableHTML += `<tr id="row-${dateStr}" ${rowClass}>
            <td>${day} <small>(${dayName})</small></td>
            <td><input type="time" id="in-${dateStr}" ${isDisabled}></td>
            <td><input type="time" id="out-${dateStr}" ${isDisabled}></td>
            <td>
              <select id="reason-${dateStr}" ${isDisabled} onchange="handleReasonChange(event)">
                <option value="">-- Pilih Alasan --</option>
                <option value="Hari Libur Sekolah">Hari Libur Sekolah</option>
                <option value="Cuti Tahunan">Cuti Tahunan</option>
                <option value="Cuti Bersalin (Anak Pertama s.d Ketiga)">Cuti Bersalin (Anak Pertama s.d Ketiga)</option>
                <option value="Cuti Bersalin (Anak Keempat dst) Bulan Pertama">Cuti Bersalin (Anak Keempat dst) Bulan Pertama</option>
                <option value="Cuti Bersalin (Anak Keempat dst) Bulan Kedua">Cuti Bersalin (Anak Keempat dst) Bulan Kedua</option>
                <option value="Cuti Bersalin (Anak Keempat dst) Bulan Ketiga">Cuti Bersalin (Anak Keempat dst) Bulan Ketiga</option>
                <option value="Cuti Besar Bulan Pertama">Cuti Besar Bulan Pertama</option>
                <option value="Cuti Besar Bulan Kedua">Cuti Besar Bulan Kedua</option>
                <option value="Cuti Besar Bulan Ketiga">Cuti Besar Bulan Ketiga</option>
                <option value="Izin Tugas belajar">Izin Tugas belajar</option>
                <option value="Izin Alasan Penting (1 s.d 2 Hari)">Izin Alasan Penting (1 s.d 2 Hari)</option>
                <option value="Izin Alasan Penting (Lebih dari 2 Hari)">Izin Alasan Penting (Lebih dari 2 Hari)</option>
                <option value="Izin Sakit (1 hari Sampai Dengan 14 Hari)">Izin Sakit (1 hari Sampai Dengan 14 Hari)</option>
                <option value="Izin Sakit (Lebih dari 14 Hari Sampai Dengan 12 Bulan)">Izin Sakit (Lebih dari 14 Hari Sampai Dengan 12 Bulan)</option>
                <option value="Izin Sakit (Lebih dari 12 Bulan Sampai Dengan 18 Bulan)">Izin Sakit (Lebih dari 12 Bulan Sampai Dengan 18 Bulan)</option>
                <option value="Dinas Luar">Dinas Luar</option>
              </select>
            </td>
            <td><button class="clear-btn" onclick="handleClearRow(event)" ${isDisabled}>Hapus</button></td>
          </tr>`;
        }
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      }
      
      function populateAttendanceData(data) {
        for(const date in data) {
          const checkInInput = document.getElementById(`in-${date}`);
          const checkOutInput = document.getElementById(`out-${date}`);
          const reasonSelect = document.getElementById(`reason-${date}`);
          
          if(checkInInput) checkInInput.value = data[date].checkIn;
          if(checkOutInput) checkOutInput.value = data[date].checkOut;
          if(reasonSelect) {
            reasonSelect.value = data[date].reason || "";
            if (data[date].reason) {
              if (checkInInput) checkInInput.disabled = true;
              if (checkOutInput) checkOutInput.disabled = true;
            }
          }
        }
      }
      
      function handleReasonChange(event) {
        const selectElement = event.target;
        const hasReason = selectElement.value !== "";
        const row = selectElement.closest('tr');
        const timeInputs = row.querySelectorAll('input[type="time"]');

        timeInputs.forEach(input => {
          input.disabled = hasReason;
          if (hasReason) {
            input.value = '';
          }
        });
      }

      function handleClearRow(event) {
        event.preventDefault(); 
        const row = event.target.closest('tr');
        const timeInputs = row.querySelectorAll('input[type="time"]');
        const reasonSelect = row.querySelector('select');
        
        timeInputs.forEach(input => {
          input.value = '';
          input.disabled = false; 
        });
        
        if (reasonSelect) {
          reasonSelect.value = '';
        }
      }

      function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        loadAttendanceForMonth(currentDate);
      }

      function handleSave() {
        const button = event.target;
        button.disabled = true;
        button.textContent = "Menyimpan...";
        document.getElementById('save-message').innerText = "";
        const attendancePayload = {
            email: currentUser.email,
            name: currentUser.name,
            school: currentUser.school,
            attendance: {}
        };
        const rows = document.querySelectorAll('#attendance-table-container tbody tr');
        rows.forEach(row => {
          const date = row.id.replace('row-', '');
          const checkIn = row.querySelector('td:nth-child(2) input').value;
          const checkOut = row.querySelector('td:nth-child(3) input').value;
          const reason = row.querySelector('td:nth-child(4) select').value;
          
          // --- INILAH PERUBAIKANNYA ---
          // Hapus kondisi 'if', sehingga data kosong pun akan dikirim.
          attendancePayload.attendance[date] = { checkIn, checkOut, reason };
        });

        google.script.run
          .withSuccessHandler(response => {
            document.getElementById('save-message').innerText = response.message;
            button.disabled = false;
            button.textContent = "Simpan Semua Perubahan";
          })
          .withFailureHandler(error => {
            document.getElementById('save-message').innerText = "Error: " + error.message;
            button.disabled = false;
            button.textContent = "Simpan Semua Perubahan";
          })
          .saveMonthlyAttendance(attendancePayload);
      }
      
      function handleLogout() {
        sessionStorage.removeItem('ceklokUser');
        currentUser = null;
        currentDate = new Date();
        document.getElementById("login-container").style.display = "block";
        document.getElementById("dashboard-container").style.display = "none";
        document.getElementById('email').value = "";
        document.getElementById('password').value = "";
        document.getElementById('login-message').innerText = "Anda berhasil logout.";
      }
    </script>
  </body>
</html>
